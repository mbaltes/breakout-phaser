<!doctype html> 
<html lang="en"> 
<head>
    
    <link href="https://fonts.googleapis.com/css?family=Electrolize&display=swap" rel="stylesheet">
 
    <meta charset="UTF-8" />
    <title>Breakout</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin-left: 50px;
            background-color: black;
            font-family: 'Electrolize', sans-serif;
        }
    </style>
</head>
<body>

<script type="text/javascript">

let config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 0 },
            debug: false
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    },
    audio: {
        disableWebAudio: true,
    }
};

const AIDIFFICULTY = 250;
const DELAY = 2000;
const MAX_ALLOWED_SPEED = 900;
const PADDLEHEIGHT = 50;
const PADDLEWIDTH = 60;
//const MAXBOUNCEANGLE = 2 * Math.PI/12;
const MAXBOUNCEANGLE = Math.PI/9;

let ballSpeedY = 300;
let ballSpeedX = 200;
let p1Score = 0;
let p2Score = 0;
let balls;
let cursors;
let playerOne;
let playerTwo;
let ball;
let playerOneScore;
let playerTwoScore;
let winningText;
let walls;
let playerLivesText;
let playerLives = 5;
let blueBar;
let bars;
let greenBar;
let yellowBar;
let orangeBar;
let brownBar;
let redBar;
let hitCounter = 0;

let game = new Phaser.Game(config);

function preload()
{
    // Load assets
    this.load.image('paddle', 'assets/breakout-paddle.png');
    this.load.image('background', 'assets/pong-bg.png');
    this.load.image('ball', 'assets/ball.png');
    this.load.image('vertical-wall', 'assets/vertical-wall.png');
    this.load.image('horizontal-wall', 'assets/horizontal-wall.png');
    this.load.image('blue-bar', 'assets/blue-bar2.png');
    this.load.image('green-bar', 'assets/green-bar2.png');
    this.load.image('yellow-bar', 'assets/yellow-bar2.png');
    this.load.image('orange-bar', 'assets/orange-bar.png');
    this.load.image('brown-bar', 'assets/brown-bar.png');
    this.load.image('red-bar', 'assets/red-bar.png');
    this.load.audio('blip-paddle', 'assets/blip-paddle.wav', {instances: 1});
    this.load.audio('blip-wall', 'assets/blip-wall.wav', {instances: 1});
    this.load.audio('blip-score', 'assets/blip-score.wav', {instances: 1});
}

function create()
{
    // Background image
    this.add.image(400, 300, 'background');

    // Create vertical walls
    walls = this.physics.add.staticGroup();
    walls.create(25, 400, 'vertical-wall');
    walls.create(775, 400, 'vertical-wall');
    walls.create(400, 100, 'horizontal-wall');

    // Create blue line
    blueBar = this.physics.add.staticGroup();
    blueBar.create(75,  300, 'blue-bar');
    blueBar.create(125, 300, 'blue-bar');
    blueBar.create(175, 300, 'blue-bar');
    blueBar.create(225, 300, 'blue-bar');
    blueBar.create(275, 300, 'blue-bar');
    blueBar.create(325, 300, 'blue-bar');
    blueBar.create(375, 300, 'blue-bar');
    blueBar.create(425, 300, 'blue-bar');
    blueBar.create(475, 300, 'blue-bar');
    blueBar.create(525, 300, 'blue-bar');
    blueBar.create(575, 300, 'blue-bar');
    blueBar.create(625, 300, 'blue-bar');
    blueBar.create(675, 300, 'blue-bar');
    blueBar.create(725, 300, 'blue-bar');

    // Create green line
    greenBar = this.physics.add.staticGroup();
    greenBar.create(75,  280, 'green-bar');
    greenBar.create(125, 280, 'green-bar');
    greenBar.create(175, 280, 'green-bar');
    greenBar.create(225, 280, 'green-bar');
    greenBar.create(275, 280, 'green-bar');
    greenBar.create(325, 280, 'green-bar');
    greenBar.create(375, 280, 'green-bar');
    greenBar.create(425, 280, 'green-bar');
    greenBar.create(475, 280, 'green-bar');
    greenBar.create(525, 280, 'green-bar');
    greenBar.create(575, 280, 'green-bar');
    greenBar.create(625, 280, 'green-bar');
    greenBar.create(675, 280, 'green-bar');
    greenBar.create(725, 280, 'green-bar');

    // Create yellow line
    yellowBar = this.physics.add.staticGroup();
    yellowBar.create(75,  260, 'yellow-bar');
    yellowBar.create(125, 260, 'yellow-bar');
    yellowBar.create(175, 260, 'yellow-bar');
    yellowBar.create(225, 260, 'yellow-bar');
    yellowBar.create(275, 260, 'yellow-bar');
    yellowBar.create(325, 260, 'yellow-bar');
    yellowBar.create(375, 260, 'yellow-bar');
    yellowBar.create(425, 260, 'yellow-bar');
    yellowBar.create(475, 260, 'yellow-bar');
    yellowBar.create(525, 260, 'yellow-bar');
    yellowBar.create(575, 260, 'yellow-bar');
    yellowBar.create(625, 260, 'yellow-bar');
    yellowBar.create(675, 260, 'yellow-bar');
    yellowBar.create(725, 260, 'yellow-bar');

    // Create orange line
    orangeBar = this.physics.add.staticGroup();
    orangeBar.create(75,  240, 'orange-bar');
    orangeBar.create(125, 240, 'orange-bar');
    orangeBar.create(175, 240, 'orange-bar');
    orangeBar.create(225, 240, 'orange-bar');
    orangeBar.create(275, 240, 'orange-bar');
    orangeBar.create(325, 240, 'orange-bar');
    orangeBar.create(375, 240, 'orange-bar');
    orangeBar.create(425, 240, 'orange-bar');
    orangeBar.create(475, 240, 'orange-bar');
    orangeBar.create(525, 240, 'orange-bar');
    orangeBar.create(575, 240, 'orange-bar');
    orangeBar.create(625, 240, 'orange-bar');
    orangeBar.create(675, 240, 'orange-bar');
    orangeBar.create(725, 240, 'orange-bar');

    // Create brown line
    brownBar = this.physics.add.staticGroup();
    brownBar.create(75,  220, 'brown-bar');
    brownBar.create(125, 220, 'brown-bar');
    brownBar.create(175, 220, 'brown-bar');
    brownBar.create(225, 220, 'brown-bar');
    brownBar.create(275, 220, 'brown-bar');
    brownBar.create(325, 220, 'brown-bar');
    brownBar.create(375, 220, 'brown-bar');
    brownBar.create(425, 220, 'brown-bar');
    brownBar.create(475, 220, 'brown-bar');
    brownBar.create(525, 220, 'brown-bar');
    brownBar.create(575, 220, 'brown-bar');
    brownBar.create(625, 220, 'brown-bar');
    brownBar.create(675, 220, 'brown-bar');
    brownBar.create(725, 220, 'brown-bar');

    // Create red line
    redBar = this.physics.add.staticGroup();
    redBar.create(75,  200, 'red-bar');
    redBar.create(125, 200, 'red-bar');
    redBar.create(175, 200, 'red-bar');
    redBar.create(225, 200, 'red-bar');
    redBar.create(275, 200, 'red-bar');
    redBar.create(325, 200, 'red-bar');
    redBar.create(375, 200, 'red-bar');
    redBar.create(425, 200, 'red-bar');
    redBar.create(475, 200, 'red-bar');
    redBar.create(525, 200, 'red-bar');
    redBar.create(575, 200, 'red-bar');
    redBar.create(625, 200, 'red-bar');
    redBar.create(675, 200, 'red-bar');
    redBar.create(725, 200, 'red-bar');



    // Create paddles
    playerOne = this.physics.add.image(400, 575, 'paddle');
    playerOne.setCollideWorldBounds(true);
    playerOne.setImmovable(true);

    // Create ball
    balls = this.physics.add.group();
    ball = balls.create(700, 330, 'ball');
    ball.setBounce(1);
    ball.setTint(0xc84848);
    ball.setCollideWorldBounds(true);
    ball.setVelocity(-ballSpeedX, ballSpeedY);
    ball.allowGravity = false;

    // Keyboard inputs
    cursors = this.input.keyboard.createCursorKeys();

    // Create sounds
    this.sound.add('blip-paddle');
    this.sound.add('blip-wall');
    this.sound.add('blip-score');

    // Create score view
    playerOneScore = this.add.text(200, 17, '000', {
        fontSize: '64px',
        fill: '#8e8e8e',
        fontFamily: 'Electrolize'
    });

    playerLivesText = this.add.text(550, 17, '3', {
        fontSize: '64px',
        fill: '#8e8e8e',
        fontFamily: 'Electrolize'
    });

    // winningText    = this.add.text(200, 400, '', { 
    //     fontSize: '64px', 
    //     fill: '#f9f9fa' 
    // });

    // Create collision detection
    this.physics.add.collider(playerOne, walls);
    this.physics.add.collider(balls, walls);
    this.physics.add.collider(ball, blueBar, barCollide, null, this);
    this.physics.add.collider(ball, greenBar, barCollide, null, this);
    this.physics.add.collider(ball, yellowBar, barCollide, null, this);
    this.physics.add.collider(ball, orangeBar, barCollideOrange, null, this);
    this.physics.add.collider(ball, brownBar, barCollide, null, this);
    this.physics.add.collider(ball, redBar, barCollide, null, this);
    this.physics.add.collider(ball, playerOne, hitplayerOne, null, this);
    this.physics.add.overlap(playerOne, walls, wallOverlap, null, this);
}

function update()
{
    // Code for AI to play itself
    // if (ball.body.position.x < playerOne.body.position.x) {
    //     playerOne.setVelocityX(-400);
    // } else if (ball.body.position.x > playerOne.body.position.x) {
    //     playerOne.setVelocityX(400);
    // } else {
    //     playerOne.setVelocity(0);
    // }

    // Conditions to lose life
    if (ball.body.position.y === 590) {
        this.sound.play('blip-score');
        hitCounter = 0;
        ball.x = 700;
        ball.y = 330;
        ball.setTint(0x000000);
        ball.setVelocity(0, 0);
        playerLivesText.setText('' + (--playerLives));
        if (playerLives === 0) {
            return;
        }
        setTimeout(() => { // The ball will be served after a brief DELAY
            ball.setTint(0xc84848);
            ball.x = 700;
            ball.y = 330;
            ballSpeedY = 300;
            ballSpeedX = 200;
            ball.setVelocity(-ballSpeedX, ballSpeedY);
        }, DELAY);
    }

    // Human player input controls
    if (cursors.left.isDown) {
        playerOne.setVelocityX(-600);
    } else if (cursors.right.isDown) {
        playerOne.setVelocityX(600);
    } else {
        playerOne.setVelocityX(0);
    }
}

function barCollide(ball, bar) {
    bar.disableBody(true, true);
    playerOneScore.setText(('000' + (++p1Score)).substr(-3));
}

function barCollideOrange(ball, bar) {
    bar.disableBody(true, true);
    playerOneScore.setText(('000' + (++p1Score)).substr(-3));
    // ball.body.setVelocityX(ball.body.velocity.x * 2);
    // ball.body.setVelocityY(ball.body.velocity.y * 2);

}

function wallOverlap(playerOne, walls) {
    if (playerOne.body.position.x < 400) {
        playerOne.body.position.x = 50;
    } else {
        playerOne.body.position.x = 690;
    }
}

function hitplayerOne(ball, playerOne) {
    this.sound.play('blip-paddle');
    // ballSpeedY = (ballSpeedY + 75) > MAX_ALLOWED_SPEED ? 
    //     MAX_ALLOWED_SPEED : ballSpeedY + 75;

    hitCounter++;
    if (hitCounter === 8) {
        ball.body.setVelocityX(ballSpeedX * 2);
    }

    let paddle1X = playerOne.body.position.x;
    let intersectX = ball.body.position.x;

    let relativeIntersectX = (paddle1X+(PADDLEWIDTH/2)) - intersectX;
    let normalizedRelativeIntersectionX = (relativeIntersectX/(PADDLEWIDTH/2));


    if (normalizedRelativeIntersectionX > 0 && ball.body.velocity.x < 0) {
        ball.setVelocityY(-ballSpeedY);
    } else if (normalizedRelativeIntersectionX > 0 && ball.body.velocity.x > 0) {
        ball.setVelocity(-ball.body.velocity.x, -ballSpeedY);
    } else if (normalizedRelativeIntersectionX < 0 && ball.body.velocity.x < 0) {
        ball.setVelocity(-ball.body.velocity.x, -ballSpeedY);
    } else if (normalizedRelativeIntersectionX < 0 && ball.body.velocity.x > 0) {
        ball.setVelocityY(-ballSpeedY);
    }
}

</script>

</body>
</html>